<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="susidns" default="all" basedir=".">
	<property name="jetty" value="../../jetty/" />
	<property name="project" value="susidns" />
	<property name="src" value="java/src" />
	<property name="bin" value="./WEB-INF/classes" />
	<property name="lib" value="${jetty}/jettylib" />
	<property name="tmp" value="./tmp" />
	<property name="jsp" value="./jsp" />
	<path id="cp">
		<pathelement path="${classpath}" />
		<pathelement location="${bin}" />
		<pathelement location="${lib}/javax.servlet.jar"/>
		<pathelement location="${lib}/org.mortbay.jetty.jar"/>
        <pathelement location="WEB-INF/lib/jstl.jar" />
        <pathelement location="WEB-INF/lib/standard.jar" />
        <pathelement location="${lib}/jasper-compiler.jar" />
        <pathelement location="${lib}/jasper-runtime.jar" />
        <pathelement location="${lib}/javax.servlet.jar" />
        <pathelement location="${lib}/commons-logging.jar" />
        <pathelement location="${lib}/commons-el.jar" />
        <pathelement location="${lib}/ant.jar" />
        <pathelement location="../../../core/java/build/i2p.jar" />
 	</path>
	<property name="javac.compilerargs" value="" />
 	<target name="compile">
		<mkdir dir="${bin}" />
		<javac debug="true" deprecation="on" source="1.5" target="1.5"
 			classpathref="cp" destdir="${bin}" srcdir="${src}" includes="**/*.java" >
			<compilerarg line="${javac.compilerargs}" />
		</javac>
	</target>
    <target name="precompilejsp" unless="precompilejsp.uptodate">
        <delete file="WEB-INF/web-fragment.xml" />
        <delete file="WEB-INF/web-out.xml" />
    	<mkdir dir="${tmp}" />
        <echo message="Ignore any warning about /WEB-INF/web.xml not found" />
        <java classname="org.apache.jasper.JspC" fork="true" classpathref="cp" failonerror="true">
            <arg value="-d" />
            <arg value="${tmp}" />
            <arg value="-v" />
            <arg value="-p" />
            <arg value="i2p.susi.dns.jsp" />
            <arg value="-webinc" />
            <arg value="WEB-INF/web-fragment.xml" />
            <arg value="-webapp" />
            <arg value="./jsp" />
        </java>
        <javac debug="true" deprecation="on" source="1.5" target="1.5" 
               destdir="${bin}" srcdir="${tmp}" includes="**/*.java" classpathref="cp">
		<compilerarg line="${javac.compilerargs}" />
         </javac>
        <copy file="WEB-INF/web-template.xml" tofile="WEB-INF/web-out.xml" />
        <loadfile property="jspc.web.fragment" srcfile="WEB-INF/web-fragment.xml" />
        <replace file="WEB-INF//web-out.xml">
            <replacefilter token="&lt;!-- precompiled servlets --&gt;" value="${jspc.web.fragment}" />
        </replace>
    </target>

    <uptodate property="precompilejsp.uptodate" targetfile="WEB-INF/web-out.xml">
        <srcfiles dir= "." includes="jsp/*.jsp, WEB-INF/web-template.xml"/>
    </uptodate>

    <target name="all" depends="compile,precompilejsp,bundle,war"/> 
    <target name="war"> 
        <war destfile="${project}.war" webxml="WEB-INF/web-out.xml">
        	<fileset dir=".">
        		<include name="WEB-INF/**/*.class"/>
        		<include name="WEB-INF/lib/*.jar"/>
        		<include name="images/*.png"/>
        		<include name="css.css"/>
        		<include name="index.html"/>
        		<include name="WEB-INF/web-out.xml"/>
        		<include name="WEB-INF/classes/${project}.properties"/>
        	</fileset>
        </war>
    </target>

    <target name="bundle" depends="compile, precompilejsp">
        <!-- Update the messages_*.po files.
             We need to supply the bat file for windows, and then change the fail property to true -->
        <exec executable="sh" osfamily="unix" failifexecutionfails="false" >
            <arg value="./bundle-messages.sh" />
        </exec>
        <exec executable="sh" osfamily="mac" failifexecutionfails="false" >
            <arg value="./bundle-messages.sh" />
        </exec>
        <exec executable="cmd" osfamily="windows" failifexecutionfails="false" >
            <arg value="/c" />
            <arg value="bundle-messages.bat" />
        </exec>
    </target>

    <target name="poupdate" depends="compile, precompilejsp">
        <!-- Update the messages_*.po files.  -->
        <exec executable="sh" osfamily="unix" failifexecutionfails="true" >
            <arg value="./bundle-messages.sh" />
            <arg value="-p" />
        </exec>
        <exec executable="sh" osfamily="mac" failifexecutionfails="true" >
            <arg value="./bundle-messages.sh" />
            <arg value="-p" />
        </exec>
        <exec executable="cmd" osfamily="windows" failifexecutionfails="true" >
            <arg value="/c" />
            <arg value="bundle-messages.bat" />
            <arg value="-p" />
        </exec>
    </target>

    <target name="clean">
      <delete file="susidns.war" />
      <delete>
        <fileset dir="." includes="**/*.class" />
        <fileset dir="." includes="tmp" />
        <fileset dir="WEB-INF" includes="web-fragment.xml, web-out.xml" />
      </delete>
      <delete dir="${bin}" />
      <delete dir="${tmp}" />
    </target>
    <target name="distclean" depends="clean" />
</project>
