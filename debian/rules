#!/usr/bin/make -f

VERSION=`grep String\ VERSION core/java/src/net/i2p/CoreVersion.java | cut -d\" -f2`
SOURCEURL=http://mirror.i2p2.de/i2psource_${VERSION}.tar.bz2

build:
	ant preppkg-linux-only
	mkdir -p debian/tmp/usr/lib
	mkdir -p debian/tmp/etc/init.d
	cp -a debian/scripts/init debian/tmp/etc/init.d/i2p
	cp -a pkg-temp debian/tmp/usr/lib/i2p
	chmod +x debian/tmp/usr/lib/i2p/postinstall.sh
	sed 's|$$INSTALL_PATH|/usr/lib/i2p|g' debian/tmp/usr/lib/i2p/wrapper.config > debian/tmp/usr/lib/i2p/a
	sed 's|$$SYSTEM_java_io_tmpdir|/tmp|g' debian/tmp/usr/lib/i2p/a > debian/tmp/usr/lib/i2p/wrapper.config
	mkdir -p debian/tmp/usr/bin
	sed 's|%INSTALL_PATH|/usr/lib/i2p|g' debian/tmp/usr/lib/i2p/eepget > debian/tmp/usr/lib/i2p/a
	mv debian/tmp/usr/lib/i2p/a debian/tmp/usr/lib/i2p/eepget
	ln -s /usr/lib/i2p/eepget debian/tmp/usr/bin/eepget
	sed 's|%INSTALL_PATH|/usr/lib/i2p|g' debian/tmp/usr/lib/i2p/runplain.sh > debian/tmp/usr/lib/i2p/a
	sed 's|%SYSTEM_java_io_tmpdir|/tmp|g' debian/tmp/usr/lib/i2p/a > debian/tmp/usr/lib/i2p/runplain.sh
	sed 's|%INSTALL_PATH|/usr/lib/i2p|g' debian/tmp/usr/lib/i2p/i2prouter > debian/tmp/usr/lib/i2p/a
	sed 's|%SYSTEM_java_io_tmpdir|/tmp|g' debian/tmp/usr/lib/i2p/a > debian/tmp/usr/lib/i2p/i2prouter
	ln -s /usr/lib/i2p/i2prouter debian/tmp/usr/bin/i2prouter
	rm debian/tmp/usr/lib/i2p/a
	touch debian/build

binary: build
	mkdir -p debian/tmp/DEBIAN
	dpkg-gencontrol
	cp -a debian/scripts/postinst debian/scripts/postrm debian/scripts/prerm debian/tmp/DEBIAN
	dpkg-deb -b debian/tmp ..

clean:
	rm -f debian/build
	rm -rf debian/tmp/
	ant distclean
	@exit 0

get-orig-source:
	wget ${SOURCEURL}
